<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Agent,JVM," />










<meta name="description" content="前言在前段时间,通过 Arthas 解决了一次代码性能问题的排查,并找到了问题的根因. 而 Arthas 和 Jstack 这类线上诊断工具通过通过 Agent 实现对,所以先对 Agent 的实现方式进行了解. 介绍Agent 通过 JVM 对外提过的 JVMTI(JVM Tool Interface) 实现. 通过 JVMTI , 外部进程可以获取到运行时 JVM 的诸多信息, 比如线程、GC">
<meta property="og:type" content="article">
<meta property="og:title" content="Java Agent 工作原理">
<meta property="og:url" content="http://yoursite.com/2020/05/30/Java-Agent-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="虚位以待">
<meta property="og:description" content="前言在前段时间,通过 Arthas 解决了一次代码性能问题的排查,并找到了问题的根因. 而 Arthas 和 Jstack 这类线上诊断工具通过通过 Agent 实现对,所以先对 Agent 的实现方式进行了解. 介绍Agent 通过 JVM 对外提过的 JVMTI(JVM Tool Interface) 实现. 通过 JVMTI , 外部进程可以获取到运行时 JVM 的诸多信息, 比如线程、GC">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-05-30T14:27:27.000Z">
<meta property="article:modified_time" content="2020-05-31T05:27:14.000Z">
<meta property="article:author" content="wang xu">
<meta property="article:tag" content="Agent">
<meta property="article:tag" content="JVM">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/05/30/Java-Agent-工作原理/"/>





  <title>Java Agent 工作原理 | 虚位以待</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">虚位以待</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/30/Java-Agent-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wang xu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="虚位以待">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Java Agent 工作原理</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-30T22:27:27+08:00">
                2020-05-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在前段时间,通过 <code>Arthas</code> 解决了一次代码性能问题的排查,并找到了问题的根因. 而 <code>Arthas</code> 和 <code>Jstack</code> 这类线上诊断工具通过通过 <code>Agent</code> 实现对,所以先对 <code>Agent</code> 的实现方式进行了解.</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><code>Agent</code> 通过 <code>JVM</code> 对外提过的 <code>JVMTI(JVM Tool Interface)</code> 实现.</p>
<p>通过 <code>JVMTI</code> , 外部进程可以获取到运行时 <code>JVM</code> 的诸多信息, 比如线程、GC等.</p>
<p><code>Agent</code> 是一个运行在目标JVM的特定程序,它的职责是负责从目标JVM中获取数据,然后将数据传递给外部进程.加载Agent的时机可以是目标JVM启动之时,也可以是在目标JVM运行时进行加载.</p>
<h2 id="实现-Agent"><a href="#实现-Agent" class="headerlink" title="实现 Agent"></a>实现 Agent</h2><p><code>JVMTI</code> 是一套 Native 接口,在Java SE 5之前,要实现一个 <code>Agent</code> 只能通过编写Native代码来实现.从Java SE 5开始,可以使用 <code>Java</code> 的 <code>Instrumentation</code> 接口来编写Agent。</p>
<h3 id="通过-Agent-Instrumentation-API-实现"><a href="#通过-Agent-Instrumentation-API-实现" class="headerlink" title="通过 Agent Instrumentation API 实现"></a>通过 Agent Instrumentation API 实现</h3><h4 id="实现-Agent-启动方法"><a href="#实现-Agent-启动方法" class="headerlink" title="实现 Agent 启动方法"></a>实现 <code>Agent</code> 启动方法</h4><p><code>Agent</code> 支持目标 <code>JVM</code> 启动时加载,也支持在目标 <code>JVM</code> 运行时加载.这两种不同的加载模式会使用不同的入口函数:</p>
<ul>
<li><p>启动时加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [1]</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [2]</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>JVM</code> 将首先寻找 [1] ,如果没有发现 [1] ,再寻找 [2] .</p>
</li>
<li><p>运行时加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [1]</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span></span>;</span><br><span class="line"><span class="comment">// [2]</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs)</span></span>;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>这两组方法的第一个参数 <code>AgentArgs</code> 是随同 <code>– javaagent</code> 一起传入的程序参数,如果这个字符串代表了多个参数,就需要自己解析这些参数. <code>inst</code> 是 <code>Instrumentation</code> 类型的对象, 是 <code>JVM</code> 自动传入的, 可以拿这个参数进行类增强等操作.</p>
<h4 id="ManiFest-文件"><a href="#ManiFest-文件" class="headerlink" title="ManiFest 文件"></a>ManiFest 文件</h4><p> <code>Agent</code> 打成的 <code>jar</code> 包中,需要在 <code>ManiFest</code> 文件中指定 <code>Premain-Class</code> 或 <code>Agent-Class</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Premain-Class: class</span><br><span class="line">Agent-Class: class</span><br></pre></td></tr></table></figure>

<h4 id="加载-Agent"><a href="#加载-Agent" class="headerlink" title="加载 Agent"></a>加载 <code>Agent</code></h4><ul>
<li><p>启动时加载</p>
<p>指定 <code>javaagent</code> 参数</p>
</li>
<li><p>运行时加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attachAgentToTargetJVM</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  List&lt;VirtualMachineDescriptor&gt; virtualMachineDescriptors = VirtualMachine.list();</span><br><span class="line">  VirtualMachineDescriptor targetVM = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (VirtualMachineDescriptor descriptor : virtualMachineDescriptors) &#123;</span><br><span class="line">    <span class="keyword">if</span> (descriptor.id().equals(configure.getPid())) &#123;</span><br><span class="line">      targetVM = descriptor;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (targetVM == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"could not find the target jvm by process id:"</span> + configure.getPid());</span><br><span class="line">  &#125;</span><br><span class="line">  VirtualMachine virtualMachine = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    virtualMachine = VirtualMachine.attach(targetVM);</span><br><span class="line">    virtualMachine.loadAgent(<span class="string">"&#123;agent&#125;"</span>, <span class="string">"&#123;params&#125;"</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (virtualMachine != <span class="keyword">null</span>) &#123;</span><br><span class="line">      virtualMachine.detach();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>com.sun.tools.attach.VirtualMachine</code> 这个类代表一个JVM抽象, 可以通过这个类找到目标 <code>JVM</code> , 并且将 <code>Agent</code> 挂载到目标 <code>JVM</code> 上 .</p>
<p>首先通过指定的进程ID找到目标 <code>JVM</code> , 然后通过 <code>Attach</code> 挂载到目标 <code>JVM</code> 上, 执行加载 <code>Agent</code> 操作. <code>VirtualMachine</code> 的 <code>Attach</code> 方法就是用来将 <code>Agent</code> 挂载到目标 <code>JVM</code> 上去的, 而 <code>Detach</code> 则是将 <code>Agent</code> 从目标 <code>JVM</code> 卸载.</p>
</li>
</ul>
<h2 id="Agent-加载过程"><a href="#Agent-加载过程" class="headerlink" title="Agent 加载过程"></a>Agent 加载过程</h2><h3 id="启动时加载"><a href="#启动时加载" class="headerlink" title="启动时加载"></a>启动时加载</h3><h4 id="参数解析"><a href="#参数解析" class="headerlink" title="参数解析"></a>参数解析</h4><p>与 <code>Agent</code> 相关的启动参数有:</p>
<ul>
<li>agentlib: When used with a specified library (-agentlib:<em>&lt;libname&gt;</em>), loads a <strong>native</strong> agent library</li>
<li>agentpath: When uses with a full pathname (-agentpath:<em>&lt;path-to-agent&gt;</em>), loads a <strong>native</strong> agent library by full pathname</li>
<li>javaagent: Loads a <strong>Java</strong> programming language agent</li>
</ul>
<p><code>JVM</code> 解析参数流程如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -agentlib and -agentpath</span></span><br><span class="line"><span class="keyword">if</span> (match_option(option, <span class="string">"-agentlib:"</span>, &amp;tail) ||</span><br><span class="line">    (is_absolute_path = match_option(option, <span class="string">"-agentpath:"</span>, &amp;tail))) &#123;</span><br><span class="line">  <span class="keyword">if</span>(tail != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* pos = <span class="built_in">strchr</span>(tail, <span class="string">'='</span>);</span><br><span class="line">    <span class="keyword">size_t</span> len = (pos == <span class="literal">NULL</span>) ? <span class="built_in">strlen</span>(tail) : pos - tail;</span><br><span class="line">    <span class="keyword">char</span>* name = <span class="built_in">strncpy</span>(NEW_C_HEAP_ARRAY(<span class="keyword">char</span>, len + <span class="number">1</span>, mtArguments), tail, len);</span><br><span class="line">    name[len] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">char</span> *options = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>(pos != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      options = os::strdup_check_oom(pos + <span class="number">1</span>, mtArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> !INCLUDE_JVMTI</span></span><br><span class="line">    <span class="keyword">if</span> (valid_jdwp_agent(name, is_absolute_path)) &#123;</span><br><span class="line">      jio_fprintf(defaultStream::error_stream(),</span><br><span class="line">                  <span class="string">"Debugging agents are not supported in this VM\n"</span>);</span><br><span class="line">      <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !INCLUDE_JVMTI</span></span></span><br><span class="line">    add_init_agent(name, options, is_absolute_path);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// -javaagent</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (match_option(option, <span class="string">"-javaagent:"</span>, &amp;tail)) &#123;</span><br><span class="line">  #<span class="keyword">if</span> !INCLUDE_JVMTI</span><br><span class="line">  jio_fprintf(defaultStream::error_stream(),</span><br><span class="line">              <span class="string">"Instrumentation agents are not supported in this VM\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">if</span> (tail != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">size_t</span> length = <span class="built_in">strlen</span>(tail) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> *options = NEW_C_HEAP_ARRAY(<span class="keyword">char</span>, length, mtArguments);</span><br><span class="line">    jio_snprintf(options, length, <span class="string">"%s"</span>, tail);</span><br><span class="line">    add_init_agent(<span class="string">"instrument"</span>, options, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// java agents need module java.instrument</span></span><br><span class="line">    <span class="keyword">if</span> (!create_numbered_property(<span class="string">"jdk.module.addmods"</span>, <span class="string">"java.instrument"</span>, addmods_count++)) &#123;</span><br><span class="line">      <span class="keyword">return</span> JNI_ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !INCLUDE_JVMTI</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码片段截取自 <code>hotspot/src/share/vm/runtime/arguments.cpp</code> 中的 <code>Arguments::parse_each_vm_init_arg(const JavaVMInitArgs* args, bool* patch_mod_javabase, Flag::Flags origin)</code> 函数,该函数用来解析一个具体的JVM参数.</p>
<p>对于 <code>Agent</code> 参数的解析,需要注意 <code>name</code> 的取值, <code>agentlib</code> 与 <code>agentpath</code> 的取值来源于启动参数, 而 <code>javaagent</code> 的 <code>name</code> 是固定的 <code>instrument</code> .</p>
<p>在解析好启动参数后,将 <code>Agent</code> 通过 <code>add_init_agent</code> 函数保存 :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> AgentLibraryList _agentList;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add_init_agent</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">char</span>* options, <span class="keyword">bool</span> absolute_path)</span></span></span><br><span class="line"><span class="function"></span>&#123; _agentList.add(<span class="keyword">new</span> AgentLibrary(name, options, absolute_path, <span class="literal">NULL</span>)); &#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行加载"><a href="#执行加载" class="headerlink" title="执行加载"></a>执行加载</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Launch -agentlib/-agentpath and converted -Xrun agents</span></span><br><span class="line"><span class="keyword">if</span> (Arguments::init_agents_at_startup()) &#123;</span><br><span class="line">	create_vm_init_agents();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">init_agents_at_startup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> !_agentList.is_empty(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当判断 <code>Agent</code> 不为空时,调用 <code>init_agents_at_startup</code> 加载 <code>Agent</code> :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Threads::create_vm_init_agents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  AgentLibrary* agent;</span><br><span class="line">  <span class="keyword">for</span> (agent = Arguments::agents(); agent != <span class="literal">NULL</span>; agent = agent-&gt;next()) &#123;</span><br><span class="line">    OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);</span><br><span class="line">    <span class="keyword">if</span> (on_load_entry != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="comment">// Invoke the Agent_OnLoad function</span></span><br><span class="line">      jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>create_vm_init_agents</code> 函数通过遍历 <code>Agent</code> 链表来逐个加载 <code>Agent</code> .通过这段代码可以看出,首先通过 <code>lookup_agent_on_load</code> 来加载 <code>Agent</code> 并且找到 <code>Agent_OnLoad</code> 函数,这个函数是Agent的入口函数. 如果没找到这个函数, 则认为是加载了一个不合法的 <code>Agent</code> ,则什么也不做,否则调用这个函数,这样 <code>Agent</code> 的代码就开始执行起来了.</p>
<p>对于使用 <code>Java Instrumentation API</code> 来编写 <code>Agent</code> 的方式来说, 在解析阶段观察到在 <code>add_init_agent</code> 函数里面传递进去的是一个叫做 <code>instrument</code> 的字符串,其实这是一个动态链接库.在Linux里面,这个库叫做 <code>libinstrument.so</code> ,在BSD系统中叫做 <code>libinstrument.dylib</code> ,该动态链接库在 <code>{JAVA_HOME}/jre/lib/</code> 目录下.</p>
<h4 id="instrument-动态链接库"><a href="#instrument-动态链接库" class="headerlink" title="instrument 动态链接库"></a><code>instrument</code> 动态链接库</h4><p><code>libinstrument</code> 用来支持使用 Java Instrumentation API 来编写 <code>Agent</code> , 在 <code>libinstrument</code> 中有一个非常重要的类称为: <code>JPLISAgent（Java Programming Language Instrumentation Services Agent）</code> ,它的作用是初始化所有通过 Java Instrumentation API 编写的 <code>Agent</code> , 并且也承担着通过 JVMTI 实现 Java Instrumentation 中暴露 API 的责任.</p>
<p>首先看入口函数 <code>Agent_OnLoad</code> 的实现:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">DEF_Agent_OnLoad(JavaVM *vm, <span class="keyword">char</span> *tail, <span class="keyword">void</span> * reserved) &#123;</span><br><span class="line">    initerror = createNewJPLISAgent(vm, &amp;agent);</span><br><span class="line">    <span class="keyword">if</span> ( initerror == JPLIS_INIT_ERROR_NONE ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (parseArgumentTail(tail, &amp;jarfile, &amp;options) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"-javaagent: memory allocation failure.\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">        &#125;</span><br><span class="line">        attributes = readAttributes(jarfile);</span><br><span class="line">        premainClass = getAttribute(attributes, <span class="string">"Premain-Class"</span>);</span><br><span class="line">        <span class="comment">/* Save the jarfile name */</span></span><br><span class="line">        agent-&gt;mJarfile = jarfile;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Convert JAR attributes into agent capabilities</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        convertCapabilityAttributes(attributes, agent);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Track (record) the agent class name and options data</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initerror = recordCommandLineData(agent, premainClass, options);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码片段是经过精简的 <code>libinstrument</code> 中 <code>Agent_OnLoad</code> 实现的,大概的流程就是:先创建一个 <code>JPLISAgent</code> ,然后将 <code>ManiFest</code> 中设定的一些参数解析出来, 比如（<code>Premain-Class</code>）等. 创建了 <code>JPLISAgent</code> 之后, 调用 <code>initializeJPLISAgent</code> 对这个 <code>Agent</code> 进行初始化操作. </p>
<p>跟进 <code>initializeJPLISAgent</code> 看一下是如何初始化的:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JPLISInitializationError <span class="title">initializeJPLISAgent</span><span class="params">(JPLISAgent *agent, JavaVM *vm, jvmtiEnv *jvmtienv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* check what capabilities are available */</span></span><br><span class="line">    checkCapabilities(agent);</span><br><span class="line">    <span class="comment">/* check phase - if live phase then we don't need the VMInit event */</span></span><br><span class="line">    jvmtierror = (*jvmtienv)-&gt;GetPhase(jvmtienv, &amp;phase);</span><br><span class="line">    <span class="comment">/* now turn on the VMInit event */</span></span><br><span class="line">    <span class="keyword">if</span> ( jvmtierror == JVMTI_ERROR_NONE ) &#123;</span><br><span class="line">        jvmtiEventCallbacks callbacks;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;callbacks, <span class="number">0</span>, <span class="keyword">sizeof</span>(callbacks));</span><br><span class="line">        callbacks.VMInit = &amp;eventHandlerVMInit;</span><br><span class="line">        jvmtierror = (*jvmtienv)-&gt;SetEventCallbacks(jvmtienv,&amp;callbacks,<span class="keyword">sizeof</span>(callbacks));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( jvmtierror == JVMTI_ERROR_NONE ) &#123;</span><br><span class="line">        jvmtierror = (*jvmtienv)-&gt;SetEventNotificationMode(jvmtienv,JVMTI_ENABLE,JVMTI_EVENT_VM_INIT,<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (jvmtierror == JVMTI_ERROR_NONE)? JPLIS_INIT_ERROR_NONE : JPLIS_INIT_ERROR_FAILURE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的流程中, 通过 <code>callbacks.VMInit = &amp;eventHandlerVMInit</code> 设置了 <code>JVM</code> 启动的回调函数:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> JNICALL  <span class="title">eventHandlerVMInit</span><span class="params">( jvmtiEnv *jvmtienv,JNIEnv *jnienv,jthread thread)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">   success = processJavaStart( environment-&gt;mAgent, jnienv);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function">jboolean  <span class="title">processJavaStart</span><span class="params">(JPLISAgent *agent,JNIEnv *jnienv)</span> </span>&#123;</span><br><span class="line">    result = createInstrumentationImpl(jnienv, agent);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *  Load the Java agent, and call the premain.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> ( result ) &#123;</span><br><span class="line">        result = startJavaAgent(agent, jnienv, agent-&gt;mAgentClassName, agent-&gt;mOptionsString, agent-&gt;mPremainCaller);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">jboolean <span class="title">startJavaAgent</span><span class="params">( JPLISAgent *agent,JNIEnv *jnienv,<span class="keyword">const</span> <span class="keyword">char</span> *classname,<span class="keyword">const</span> <span class="keyword">char</span> *optionsString,jmethodID agentMainMethod)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...  </span></span><br><span class="line">  invokeJavaAgentMainMethod(jnienv,agent-&gt;mInstrumentationImpl,agentMainMethod, classNameObject,optionsStringObject);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>invokeJavaAgentMainMethod</code> 的方法中传入了 <code>premain</code> 方法所需要的 <code>agent-&gt;mInstrumentationImpl</code> 和 <code>optionsStringObject</code> 对象, 接着,就可以根据Instrument实例来做想要做的事情了.</p>
<h3 id="运行时加载"><a href="#运行时加载" class="headerlink" title="运行时加载"></a>运行时加载</h3><p>运行时加载时, <code>Agent</code> 通过 <code>attach</code> 方法和目标 <code>JVM</code> 建立通信, 而目标 <code>JVM</code> 则通过 <code>AttachListener</code> 监听此类消息.</p>
<h4 id="AttachListener"><a href="#AttachListener" class="headerlink" title="AttachListener"></a>AttachListener</h4><p><code>AttachListener</code> 负责接收其他 <code>JVM</code> 的消息,并找到对应的操作并执行,所以先介绍一下 <code>AttachListener</code> 可以处理的操作及其对应的方法:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> AttachOperationFunctionInfo funcs[] = &#123;</span><br><span class="line">  &#123; <span class="string">"agentProperties"</span>,  get_agent_properties &#125;,</span><br><span class="line">  &#123; <span class="string">"datadump"</span>,         data_dump &#125;,</span><br><span class="line">  &#123; <span class="string">"dumpheap"</span>,         dump_heap &#125;,</span><br><span class="line">  &#123; <span class="string">"load"</span>,             load_agent &#125;,</span><br><span class="line">  &#123; <span class="string">"properties"</span>,       get_system_properties &#125;,</span><br><span class="line">  &#123; <span class="string">"threaddump"</span>,       thread_dump &#125;,</span><br><span class="line">  &#123; <span class="string">"inspectheap"</span>,      heap_inspection &#125;,</span><br><span class="line">  &#123; <span class="string">"setflag"</span>,          set_flag &#125;,</span><br><span class="line">  &#123; <span class="string">"printflag"</span>,        print_flag &#125;,</span><br><span class="line">  &#123; <span class="string">"jcmd"</span>,             jcmd &#125;,</span><br><span class="line">  &#123; <span class="literal">NULL</span>,               <span class="literal">NULL</span> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中 <code>load</code> 方法就是加载 <code>Agent</code> 操作.</p>
<h5 id="AttachListener-初始化"><a href="#AttachListener-初始化" class="headerlink" title="AttachListener 初始化"></a>AttachListener 初始化</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Starts the Attach Listener thread</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AttachListener::init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建线程相关部分代码被去掉了</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> thread_name[] = <span class="string">"Attach Listener"</span>;</span><br><span class="line">  Handle <span class="built_in">string</span> = java_lang_String::create_from_str(thread_name, THREAD);</span><br><span class="line">  &#123; <span class="function">MutexLocker <span class="title">mu</span><span class="params">(Threads_lock)</span></span>;</span><br><span class="line">    JavaThread* listener_thread = <span class="keyword">new</span> JavaThread(&amp;attach_listener_thread_entry);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>listener_thread</code> 执行的方法是 <code>attach_listener_thread_entry</code> :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">attach_listener_thread_entry</span><span class="params">(JavaThread* thread, TRAPS)</span> </span>&#123;</span><br><span class="line">  AttachListener::set_initialized();</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      AttachOperation* op = AttachListener::dequeue();</span><br><span class="line">      <span class="comment">// find the function to dispatch too</span></span><br><span class="line">      AttachOperationFunctionInfo* info = <span class="literal">NULL</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; funcs[i].name != <span class="literal">NULL</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* name = funcs[i].name;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(op-&gt;name(), name) == <span class="number">0</span>) &#123;</span><br><span class="line">          info = &amp;(funcs[i]); <span class="keyword">break</span>;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">       <span class="comment">// dispatch to the function that implements this operation</span></span><br><span class="line">        res = (info-&gt;func)(op, &amp;st);</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个函数执行逻辑，大概是这样的:</p>
<ul>
<li>拉取一个需要执行的任务：AttachListener::dequeue。</li>
<li>查询匹配的命令处理函数。</li>
<li>执行匹配到的命令执行函数。</li>
</ul>
<h5 id="AttachListener-懒加载"><a href="#AttachListener-懒加载" class="headerlink" title="AttachListener 懒加载"></a>AttachListener 懒加载</h5><p><code>AttachListener</code> 线程并不会在 <code>JVM</code> 启动时就启动,而是通过<strong>懒加载</strong>策略启动的.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">Threads::create_vm</span><span class="params">(JavaVMInitArgs* args, <span class="keyword">bool</span>* canTryAgain)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize the os module before using TLS</span></span><br><span class="line">  os::init();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Convert -Xrun to -agentlib: if there is no JVM_OnLoad</span></span><br><span class="line">  <span class="comment">// Must be before create_vm_init_agents()</span></span><br><span class="line">  <span class="keyword">if</span> (Arguments::init_libraries_at_startup()) &#123;</span><br><span class="line">    convert_vm_init_libraries_to_agents();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Launch -agentlib/-agentpath and converted -Xrun agents</span></span><br><span class="line">  <span class="keyword">if</span> (Arguments::init_agents_at_startup()) &#123;</span><br><span class="line">    create_vm_init_agents();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Signal Dispatcher needs to be started before VMInit event is posted</span></span><br><span class="line">  os::signal_init();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Start Attach Listener if +StartAttachListener or it can't be started lazily</span></span><br><span class="line">  <span class="keyword">if</span> (!DisableAttachMechanism) &#123;</span><br><span class="line">    AttachListener::vm_start();</span><br><span class="line">    <span class="keyword">if</span> (StartAttachListener || AttachListener::init_at_startup()) &#123;</span><br><span class="line">      AttachListener::init();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码截取自 <code>create_vm</code> 函数, <code>DisableAttachMechanism</code> 、<code>StartAttachListener</code> 和 <code>ReduceSignalUsage</code> 这三个变量默认都是 <code>false</code> , 所以 <code>AttachListener::init();</code> 这行代码不会在 <code>create_vm</code> 的时候执行, 而 <code>AttachListener::vm_start</code> 会执行.</p>
<p>而 <code>AttachListener::init();</code> 的执行时机在于 <code>os::signal_init();</code> :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">os::signal_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!ReduceSignalUsage) &#123;</span><br><span class="line">    <span class="comment">// Setup JavaThread for processing signals</span></span><br><span class="line">    EXCEPTION_MARK;</span><br><span class="line">    Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_Thread(), <span class="literal">true</span>, CHECK);</span><br><span class="line">    <span class="function">instanceKlassHandle <span class="title">klass</span> <span class="params">(THREAD, k)</span></span>;</span><br><span class="line">    instanceHandle thread_oop = klass-&gt;allocate_instance_handle(CHECK);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> thread_name[] = <span class="string">"Signal Dispatcher"</span>;</span><br><span class="line">    Handle <span class="built_in">string</span> = java_lang_String::create_from_str(thread_name, CHECK);</span><br><span class="line">    <span class="comment">// Initialize thread_oop to put it into the system threadGroup</span></span><br><span class="line">    <span class="function">Handle <span class="title">thread_group</span> <span class="params">(THREAD, Universe::system_thread_group())</span></span>;</span><br><span class="line">    <span class="function">JavaValue <span class="title">result</span><span class="params">(T_VOID)</span></span>;</span><br><span class="line">    JavaCalls::call_special(&amp;result, thread_oop,klass,vmSymbols::object_initializer_name(),vmSymbols::threadgroup_string_void_signature(),</span><br><span class="line">                           thread_group,<span class="built_in">string</span>,CHECK);</span><br><span class="line">    <span class="function">KlassHandle <span class="title">group</span><span class="params">(THREAD, SystemDictionary::ThreadGroup_klass())</span></span>;</span><br><span class="line">    JavaCalls::call_special(&amp;result,thread_group,group,vmSymbols::add_method_name(),vmSymbols::thread_void_signature(),thread_oop,CHECK);</span><br><span class="line">    os::signal_init_pd();</span><br><span class="line">    &#123; <span class="function">MutexLocker <span class="title">mu</span><span class="params">(Threads_lock)</span></span>;</span><br><span class="line">      JavaThread* signal_thread = <span class="keyword">new</span> JavaThread(&amp;signal_thread_entry);</span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Handle ^BREAK</span></span><br><span class="line">    os::signal(SIGBREAK, os::user_handler());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JVM 创建了一个 <code>Signal Dispatcher</code> 线程用来处理信号:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">signal_thread_entry</span><span class="params">(JavaThread* thread, TRAPS)</span> </span>&#123;</span><br><span class="line">  os::set_priority(thread, NearMaxPriority);</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> sig;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// FIXME : Currently we have not decieded what should be the status</span></span><br><span class="line">      <span class="comment">//         for this java thread blocked here. Once we decide about</span></span><br><span class="line">      <span class="comment">//         that we should fix this.</span></span><br><span class="line">      sig = os::signal_wait();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sig == os::sigexitnum_pd()) &#123;</span><br><span class="line">       <span class="comment">// Terminate the signal thread</span></span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (sig) &#123;</span><br><span class="line">      <span class="keyword">case</span> SIGBREAK: &#123;</span><br><span class="line">        <span class="comment">// Check if the signal is a trigger to start the Attach Listener - in that</span></span><br><span class="line">        <span class="comment">// case don't print stack traces.</span></span><br><span class="line">        <span class="keyword">if</span> (!DisableAttachMechanism &amp;&amp; AttachListener::is_init_trigger()) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Print stack traces</span></span><br><span class="line">        <span class="comment">// Any SIGBREAK operations added here should make sure to flush</span></span><br><span class="line">        <span class="comment">// the output stream (e.g. tty-&gt;flush()) after output.  See 4803766.</span></span><br><span class="line">        <span class="comment">// Each module also prints an extra carriage return after its output.</span></span><br><span class="line">        VM_PrintThreads op;</span><br><span class="line">        VMThread::execute(&amp;op);</span><br><span class="line">        VM_PrintJNI jni_op;</span><br><span class="line">        VMThread::execute(&amp;jni_op);</span><br><span class="line">        <span class="function">VM_FindDeadlocks <span class="title">op1</span><span class="params">(tty)</span></span>;</span><br><span class="line">        VMThread::execute(&amp;op1);</span><br><span class="line">        Universe::print_heap_at_SIGBREAK();</span><br><span class="line">        <span class="keyword">if</span> (PrintClassHistogram) &#123;</span><br><span class="line">          <span class="function">VM_GC_HeapInspection <span class="title">op1</span><span class="params">(gclog_or_tty, <span class="literal">true</span> <span class="comment">/* force full GC before heap inspection */</span>)</span></span>;</span><br><span class="line">          VMThread::execute(&amp;op1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (JvmtiExport::should_post_data_dump()) &#123;</span><br><span class="line">          JvmtiExport::post_data_dump();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>: &#123;</span><br><span class="line">        <span class="comment">// Dispatch the signal to java</span></span><br><span class="line">        <span class="function">HandleMark <span class="title">hm</span><span class="params">(THREAD)</span></span>;</span><br><span class="line">        Klass* k = SystemDictionary::resolve_or_null(vmSymbols::sun_misc_Signal(), THREAD);</span><br><span class="line">        <span class="function">KlassHandle <span class="title">klass</span> <span class="params">(THREAD, k)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (klass.not_null()) &#123;</span><br><span class="line">          <span class="function">JavaValue <span class="title">result</span><span class="params">(T_VOID)</span></span>;</span><br><span class="line">          JavaCallArguments args;</span><br><span class="line">          args.push_int(sig);</span><br><span class="line">          JavaCalls::call_static(</span><br><span class="line">            &amp;result,</span><br><span class="line">            klass,</span><br><span class="line">            vmSymbols::dispatch_name(),</span><br><span class="line">            vmSymbols::int_void_signature(),</span><br><span class="line">            &amp;args,</span><br><span class="line">            THREAD</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (HAS_PENDING_EXCEPTION) &#123;</span><br><span class="line">          <span class="comment">// tty is initialized early so we don't expect it to be null, but</span></span><br><span class="line">          <span class="comment">// if it is we can't risk doing an initialization that might</span></span><br><span class="line">          <span class="comment">// trigger additional out-of-memory conditions</span></span><br><span class="line">          <span class="keyword">if</span> (tty != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">char</span> klass_name[<span class="number">256</span>];</span><br><span class="line">            <span class="keyword">char</span> tmp_sig_name[<span class="number">16</span>];</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span>* sig_name = <span class="string">"UNKNOWN"</span>;</span><br><span class="line">            InstanceKlass::cast(PENDING_EXCEPTION-&gt;klass())-&gt;</span><br><span class="line">              name()-&gt;as_klass_external_name(klass_name, <span class="number">256</span>);</span><br><span class="line">            <span class="keyword">if</span> (os::exception_name(sig, tmp_sig_name, <span class="number">16</span>) != <span class="literal">NULL</span>)</span><br><span class="line">              sig_name = tmp_sig_name;</span><br><span class="line">            warning(<span class="string">"Exception %s occurred dispatching signal %s to handler"</span></span><br><span class="line">                    <span class="string">"- the VM may need to be forcibly terminated"</span>,</span><br><span class="line">                    klass_name, sig_name );</span><br><span class="line">          &#125;</span><br><span class="line">          CLEAR_PENDING_EXCEPTION;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上信号处理需要关注的是 <code>SIGBREAK</code> 信号,此信号是由需要 <code>Attach</code> 到此 <code>JVM</code> 的其他 <code>JVM</code> 发出来的,当收到此信号时,会执行 <code>AttachListener::is_init_trigger()</code> :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">AttachListener::is_init_trigger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (init_at_startup() || is_initialized()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;               <span class="comment">// initialized at startup or already initialized</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">char</span> fn[PATH_MAX+<span class="number">1</span>];</span><br><span class="line">  <span class="built_in">sprintf</span>(fn, <span class="string">".attach_pid%d"</span>, os::current_process_id());</span><br><span class="line">  <span class="keyword">int</span> ret;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat64</span> <span class="title">st</span>;</span></span><br><span class="line">  RESTARTABLE(::stat64(fn, &amp;st), ret);</span><br><span class="line">  <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">    log_trace(<span class="built_in">attach</span>)(<span class="string">"Failed to find attach file: %s, trying alternate"</span>, fn);</span><br><span class="line">    <span class="built_in">snprintf</span>(fn, <span class="keyword">sizeof</span>(fn), <span class="string">"%s/.attach_pid%d"</span>, os::get_temp_directory(), os::current_process_id());</span><br><span class="line">    RESTARTABLE(::stat64(fn, &amp;st), ret);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// simple check to avoid starting the attach mechanism when</span></span><br><span class="line">    <span class="comment">// a bogus user creates the file</span></span><br><span class="line">    <span class="keyword">if</span> (st.st_uid == geteuid()) &#123;</span><br><span class="line">      init();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先检查了一下是否在 JVM 启动时启动了 <code>Attach Listener</code>, 或者是否已经启动过. 如果没有,才继续执行,在 <code>/tmp</code> 目录下创建一个叫做 <code>.attach_pid%d</code> 的文件, 然后执行 <code>AttachListener::init</code> 函数,这个函数就是用来创建 <code>Attach Listener</code> 线程的函数.</p>
<h5 id="加载-Agent-1"><a href="#加载-Agent-1" class="headerlink" title="加载 Agent"></a>加载 <code>Agent</code></h5><p>至此, <code>Attach Listener</code> 的启动过程已经介绍完了, 回到一开始, <code>AttachListener</code> 接收到 <code>AttachOperation</code> 并执行对应操作. 对于加载 <code>Agent</code> 来说, 对应的命令是 <code>load</code> .</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">load_agent</span><span class="params">(AttachOperation* op, outputStream* out)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// get agent name and options</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* agent = op-&gt;arg(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* absParam = op-&gt;arg(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* options = op-&gt;arg(<span class="number">2</span>);</span><br><span class="line">  <span class="comment">// If loading a java agent then need to ensure that the java.instrument module is loaded</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(agent, <span class="string">"instrument"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    Thread* THREAD = Thread::current();</span><br><span class="line">    <span class="function">ResourceMark <span class="title">rm</span><span class="params">(THREAD)</span></span>;</span><br><span class="line">    <span class="function">HandleMark <span class="title">hm</span><span class="params">(THREAD)</span></span>;</span><br><span class="line">    <span class="function">JavaValue <span class="title">result</span><span class="params">(T_OBJECT)</span></span>;</span><br><span class="line">    Handle h_module_name = java_lang_String::create_from_str(<span class="string">"java.instrument"</span>, THREAD);</span><br><span class="line">	JavaCalls::call_static(&amp;result,SystemDictionary::module_Modules_klass(),vmSymbols::loadModule_name(), vmSymbols::loadModule_signature(),h_module_name,THREAD);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> JvmtiExport::load_agent_library(agent, absParam, options, out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数先确保加载了 <code>java.instrument</code> 模块, 之后真正执行 <code>Agent</code> 加载的函数是 <a href="https://github.com/pandening/openjdk/blob/0301fc792ffd3c7b506ef78887af250e0e3ae09e/src/hotspot/share/prims/jvmtiExport.cpp#L2476" target="_blank" rel="noopener">load_agent_library</a> .</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">JvmtiExport::load_agent_library</span><span class="params">(AttachOperation* op, outputStream* st)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> ebuf[<span class="number">1024</span>];</span><br><span class="line">  <span class="keyword">char</span> <span class="built_in">buffer</span>[JVM_MAXPATHLEN];</span><br><span class="line">  <span class="keyword">void</span>* library = <span class="literal">NULL</span>;</span><br><span class="line">  jint result = JNI_ERR;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *on_attach_symbols[] = AGENT_ONATTACH_SYMBOLS;</span><br><span class="line">  <span class="keyword">size_t</span> num_symbol_entries = ARRAY_SIZE(on_attach_symbols);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get agent name and options</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* agent = op-&gt;arg(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* absParam = op-&gt;arg(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* options = op-&gt;arg(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The abs paramter should be "true" or "false"</span></span><br><span class="line">  <span class="keyword">bool</span> is_absolute_path = (absParam != <span class="literal">NULL</span>) &amp;&amp; (<span class="built_in">strcmp</span>(absParam,<span class="string">"true"</span>)==<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initially marked as invalid. It will be set to valid if we can find the agent</span></span><br><span class="line">  AgentLibrary *agent_lib = <span class="keyword">new</span> AgentLibrary(agent, options, is_absolute_path, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check for statically linked in agent. If not found then if the path is</span></span><br><span class="line">  <span class="comment">// absolute we attempt to load the library. Otherwise we try to load it</span></span><br><span class="line">  <span class="comment">// from the standard dll directory.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!os::find_builtin_agent(agent_lib, on_attach_symbols, num_symbol_entries)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_absolute_path) &#123;</span><br><span class="line">      library = os::dll_load(agent, ebuf, <span class="keyword">sizeof</span> ebuf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Try to load the agent from the standard dll directory</span></span><br><span class="line">      <span class="keyword">if</span> (os::dll_build_name(<span class="built_in">buffer</span>, <span class="keyword">sizeof</span>(<span class="built_in">buffer</span>), Arguments::get_dll_dir(),</span><br><span class="line">                             agent)) &#123;</span><br><span class="line">        library = os::dll_load(<span class="built_in">buffer</span>, ebuf, <span class="keyword">sizeof</span> ebuf);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (library == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// not found - try local path</span></span><br><span class="line">        <span class="keyword">char</span> ns[<span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span> (os::dll_build_name(<span class="built_in">buffer</span>, <span class="keyword">sizeof</span>(<span class="built_in">buffer</span>), ns, agent)) &#123;</span><br><span class="line">          library = os::dll_load(<span class="built_in">buffer</span>, ebuf, <span class="keyword">sizeof</span> ebuf);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (library != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      agent_lib-&gt;set_os_lib(library);</span><br><span class="line">      agent_lib-&gt;set_valid();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// If the library was loaded then we attempt to invoke the Agent_OnAttach</span></span><br><span class="line">  <span class="comment">// function</span></span><br><span class="line">  <span class="keyword">if</span> (agent_lib-&gt;valid()) &#123;</span><br><span class="line">    <span class="comment">// Lookup the Agent_OnAttach function</span></span><br><span class="line">    OnAttachEntry_t on_attach_entry = <span class="literal">NULL</span>;</span><br><span class="line">    on_attach_entry = CAST_TO_FN_PTR(OnAttachEntry_t,</span><br><span class="line">       os::find_agent_function(agent_lib, <span class="literal">false</span>, on_attach_symbols, num_symbol_entries));</span><br><span class="line">    <span class="keyword">if</span> (on_attach_entry == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="comment">// Agent_OnAttach missing - unload library</span></span><br><span class="line">      <span class="keyword">if</span> (!agent_lib-&gt;is_static_lib()) &#123;</span><br><span class="line">        os::dll_unload(library);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">delete</span> agent_lib;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Invoke the Agent_OnAttach function</span></span><br><span class="line">      JavaThread* THREAD = JavaThread::current();</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">JavaVM_</span> <span class="title">main_vm</span>;</span></span><br><span class="line">        <span class="function">JvmtiThreadEventMark <span class="title">jem</span><span class="params">(THREAD)</span></span>;</span><br><span class="line">        <span class="function">JvmtiJavaThreadEventTransition <span class="title">jet</span><span class="params">(THREAD)</span></span>;</span><br><span class="line"></span><br><span class="line">        result = (*on_attach_entry)(&amp;main_vm, (<span class="keyword">char</span>*)options, <span class="literal">NULL</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Agent_OnAttach may have used JNI</span></span><br><span class="line">      <span class="keyword">if</span> (HAS_PENDING_EXCEPTION) &#123;</span><br><span class="line">        CLEAR_PENDING_EXCEPTION;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If OnAttach returns JNI_OK then we add it to the list of</span></span><br><span class="line">      <span class="comment">// agent libraries so that we can call Agent_OnUnload later.</span></span><br><span class="line">      <span class="keyword">if</span> (result == JNI_OK) &#123;</span><br><span class="line">        Arguments::add_loaded_agent(agent_lib);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span> agent_lib;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Agent_OnAttach executed so completion status is JNI_OK</span></span><br><span class="line">      st-&gt;print_cr(<span class="string">"%d"</span>, result);</span><br><span class="line">      result = JNI_OK;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数的作用就是加载 <code>Agent</code> 动态链接库, 如果是通过 Java instrument API 实现的 <code>Agent</code> , 则加载的是 <code>libinstrument</code> 动态链接库, 然后通过 <code>libinstrument</code> 里面的代码实现运行 <code>agentmain</code> 方法的逻辑, 这一部分内容和 <code>libinstrument</code> 实现 <code>premain</code> 方法运行的逻辑其实差不多.</p>
<h5 id="Attach-至目标-JVM"><a href="#Attach-至目标-JVM" class="headerlink" title="Attach 至目标 JVM"></a>Attach 至目标 JVM</h5><p>至此,我们已经了解了目标 JVM 是如何监听 <code>load_agent</code> 消息,并运行时动态加载 <code>Agent</code> ,但是如何发送 <code>load_agent</code> 消息的过程还没有介绍.</p>
<p>通过调用 <code>VirtualMachine</code> 的 <code>attach</code> 方法进行 <code>Agent</code> 挂载的功能:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VirtualMachine <span class="title">attach</span><span class="params">(String id)</span> <span class="keyword">throws</span> AttachNotSupportedException, IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"id cannot be null"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  List&lt;AttachProvider&gt; providers = AttachProvider.providers();</span><br><span class="line">  <span class="keyword">if</span> (providers.size() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> AttachNotSupportedException(<span class="string">"no providers installed"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  AttachNotSupportedException lastExc = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (AttachProvider provider: providers) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> provider.attachVirtualMachine(id);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AttachNotSupportedException x) &#123;</span><br><span class="line">      lastExc = x;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> lastExc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终通过调用 <code>AttachProvider</code> 的 <code>attachVirtualMachine</code> 方法实现 Attach 操作.</p>
<p>在MacOS系统中, <code>AttachProvider</code> 的实现类是 <code>BsdAttachProvider</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">BsdVirtualMachine(AttachProvider provider, String vmid)</span><br><span class="line">  <span class="keyword">throws</span> AttachNotSupportedException, IOException</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">super</span>(provider, vmid);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This provider only understands pids</span></span><br><span class="line">  <span class="keyword">int</span> pid;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    pid = Integer.parseInt(vmid);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (NumberFormatException x) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> AttachNotSupportedException(<span class="string">"Invalid process identifier"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Find the socket file. If not found then we attempt to start the</span></span><br><span class="line">  <span class="comment">// attach mechanism in the target VM by sending it a QUIT signal.</span></span><br><span class="line">  <span class="comment">// Then we attempt to find the socket file again.</span></span><br><span class="line">  path = findSocketFile(pid);</span><br><span class="line">  <span class="keyword">if</span> (path == <span class="keyword">null</span>) &#123;</span><br><span class="line">    File f = <span class="keyword">new</span> File(tmpdir, <span class="string">".attach_pid"</span> + pid);</span><br><span class="line">    createAttachFile(f.getPath());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      sendQuitTo(pid);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// give the target VM time to start the attach mechanism</span></span><br><span class="line">      <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">long</span> delay = <span class="number">200</span>;</span><br><span class="line">      <span class="keyword">int</span> retries = (<span class="keyword">int</span>)(attachTimeout() / delay);</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(delay);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException x) &#123; &#125;</span><br><span class="line">        path = findSocketFile(pid);</span><br><span class="line">        i++;</span><br><span class="line">      &#125; <span class="keyword">while</span> (i &lt;= retries &amp;&amp; path == <span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">if</span> (path == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AttachNotSupportedException(</span><br><span class="line">          <span class="string">"Unable to open socket file: target process not responding "</span> +</span><br><span class="line">          <span class="string">"or HotSpot VM not loaded"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      f.delete();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check that the file owner/permission to avoid attaching to</span></span><br><span class="line">  <span class="comment">// bogus process</span></span><br><span class="line">  checkPermissions(path);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check that we can connect to the process</span></span><br><span class="line">  <span class="comment">// - this ensures we throw the permission denied error now rather than</span></span><br><span class="line">  <span class="comment">// later when we attempt to enqueue a command.</span></span><br><span class="line">  <span class="keyword">int</span> s = socket();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    connect(s, path);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    close(s);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>findSocketFile</code> 方法用来查询目标 JVM 上是否已经启动了 <code>AttachListener</code>, 它通过检查 <code>tmp/</code> 目录下是否存在 <code>java_pid{pid}</code> 来进行实现. 如果已经存在了, 则说明 Attach 机制已经准备就绪, 可以接受客户端的命令了, 这个时候客户端就可以通过 <code>connect</code> 连接到目标 JVM 进行命令的发送, 比如可以发送 <code>load</code> 命令来加载 Agent. 如果 <code>java_pid{pid}</code> 文件还不存在, 则需要通过 <code>sendQuitTo</code> 方法向目标 JVM 发送一个 <code>SIGBREAK</code> 信号, 让它初始化 <code>AttachListener</code> 线程并准备接受客户端连接. 可以看到, 发送了信号之后客户端会循环等待 <code>java_pid{pid}</code> 这个文件, 之后再通过connect连接到目标JVM上.</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本篇全文介绍了 <code>Agent</code> 的加载方式, 但是对 <code>JVM</code> 进程间的通信方式没有做了解 (<code>AttachListener::dequeue()</code>) , 需要后续补充进行了解.</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>本篇全文参考自 <a href="https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html" target="_blank" rel="noopener">Java 动态调试技术原理及实践</a> , 对部分内容顺序进行了调整和补充, 如若侵权, 请告知本人删除.</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Agent/" rel="tag"># Agent</a>
          
            <a href="/tags/JVM/" rel="tag"># JVM</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">wang xu</p>
              <p class="site-description motion-element" itemprop="description">just record learning,then enjoy understanding</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#介绍"><span class="nav-number">2.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现-Agent"><span class="nav-number">3.</span> <span class="nav-text">实现 Agent</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通过-Agent-Instrumentation-API-实现"><span class="nav-number">3.1.</span> <span class="nav-text">通过 Agent Instrumentation API 实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现-Agent-启动方法"><span class="nav-number">3.1.1.</span> <span class="nav-text">实现 Agent 启动方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ManiFest-文件"><span class="nav-number">3.1.2.</span> <span class="nav-text">ManiFest 文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#加载-Agent"><span class="nav-number">3.1.3.</span> <span class="nav-text">加载 Agent</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Agent-加载过程"><span class="nav-number">4.</span> <span class="nav-text">Agent 加载过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动时加载"><span class="nav-number">4.1.</span> <span class="nav-text">启动时加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#参数解析"><span class="nav-number">4.1.1.</span> <span class="nav-text">参数解析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行加载"><span class="nav-number">4.1.2.</span> <span class="nav-text">执行加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#instrument-动态链接库"><span class="nav-number">4.1.3.</span> <span class="nav-text">instrument 动态链接库</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运行时加载"><span class="nav-number">4.2.</span> <span class="nav-text">运行时加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AttachListener"><span class="nav-number">4.2.1.</span> <span class="nav-text">AttachListener</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#AttachListener-初始化"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">AttachListener 初始化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AttachListener-懒加载"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">AttachListener 懒加载</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#加载-Agent-1"><span class="nav-number">4.2.1.3.</span> <span class="nav-text">加载 Agent</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Attach-至目标-JVM"><span class="nav-number">4.2.1.4.</span> <span class="nav-text">Attach 至目标 JVM</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">5.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wang xu</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
